#!/usr/bin/env bash
# Pre-push hook for RAG SDK
# This runs before pushing to ensure code quality and all tests pass
# Supports: uv venv (.venv), Docker, or global installs

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}---${NC}"
echo -e "${BLUE}Running pre-push checks...${NC}"
echo -e "${BLUE}---${NC}\n"

# Get current branch
CURRENT_BRANCH=$(git branch --show-current)
echo -e "${YELLOW}Branch: ${CURRENT_BRANCH}${NC}\n"

# Detect environment
REPO_ROOT=$(git rev-parse --show-toplevel)
if [ -f "$REPO_ROOT/.venv/bin/python" ]; then
    PYTHON="$REPO_ROOT/.venv/bin/python"
    BIN_DIR="$REPO_ROOT/.venv/bin"
    ENV_LABEL="venv"
elif command -v docker &> /dev/null && [ -f "$REPO_ROOT/Dockerfile" ]; then
    ENV_LABEL="docker"
else
    PYTHON="python3"
    BIN_DIR=""
    ENV_LABEL="global"
fi

run_tool() {
    local tool=$1
    shift
    if [ "$ENV_LABEL" = "docker" ]; then
        docker run --rm rag_sdk "$tool" "$@"
    elif [ -n "$BIN_DIR" ] && [ -f "$BIN_DIR/$tool" ]; then
        "$BIN_DIR/$tool" "$@"
    elif command -v "$tool" &> /dev/null; then
        "$tool" "$@"
    else
        return 127
    fi
}

run_python() {
    if [ "$ENV_LABEL" = "docker" ]; then
        docker run --rm rag_sdk python "$@"
    elif [ -n "$PYTHON" ]; then
        "$PYTHON" "$@"
    else
        python3 "$@"
    fi
}

echo -e "${YELLOW}Environment: ${ENV_LABEL}${NC}\n"

# Flag to track if any check fails
FAILED=0

# Check 1: Run all linting checks
echo -e "${YELLOW}1. Running comprehensive linting...${NC}"
if run_tool ruff check .; then
    echo -e "${GREEN}Linting passed${NC}\n"
else
    if [ $? -eq 127 ]; then
        echo -e "${RED}Ruff not installed${NC}\n"
        FAILED=1
    else
        echo -e "${RED}Linting failed${NC}\n"
        FAILED=1
    fi
fi

# Check 2: Type checking
echo -e "${YELLOW}2. Running type checker on entire codebase...${NC}"
if run_tool mypy rag_sdk/ --ignore-missing-imports; then
    echo -e "${GREEN}Type checking passed${NC}\n"
else
    if [ $? -eq 127 ]; then
        echo -e "${RED}MyPy not installed${NC}\n"
        FAILED=1
    else
        echo -e "${RED}Type checking failed${NC}\n"
        FAILED=1
    fi
fi

# Check 3: Run unit tests
echo -e "${YELLOW}3. Running unit tests...${NC}"
if run_tool pytest tests/unit/ -v --tb=short; then
    echo -e "${GREEN}Unit tests passed${NC}\n"
else
    if [ $? -eq 127 ]; then
        echo -e "${RED}Pytest not installed${NC}\n"
        FAILED=1
    else
        echo -e "${RED}Unit tests failed${NC}\n"
        FAILED=1
    fi
fi

# Check 4: Run integration tests (if they exist)
if [ -d "tests/integration" ] && [ "$(ls -A tests/integration 2>/dev/null)" ]; then
    echo -e "${YELLOW}4. Running integration tests...${NC}"
    if run_tool pytest tests/integration/ -v --tb=short; then
        echo -e "${GREEN}Integration tests passed${NC}\n"
    else
        echo -e "${RED}Integration tests failed${NC}\n"
        FAILED=1
    fi
else
    echo -e "${YELLOW}No integration tests found, skipping${NC}\n"
fi

# Check 5: Test coverage
echo -e "${YELLOW}5. Checking test coverage...${NC}"
if run_python -c "import pytest_cov" 2>/dev/null; then
    if run_tool pytest tests/unit/ --cov=rag_sdk --cov-report=term-missing --cov-fail-under=80; then
        echo -e "${GREEN}Test coverage meets minimum threshold${NC}\n"
    else
        echo -e "${RED}Test coverage below 80%${NC}\n"
        FAILED=1
    fi
else
    echo -e "${YELLOW}pytest-cov not installed, skipping coverage check${NC}\n"
fi

# Check 6: Security checks
echo -e "${YELLOW}6. Running security checks...${NC}"
if run_tool bandit -r rag_sdk/ -ll -q 2>/dev/null; then
    echo -e "${GREEN}Security scan passed${NC}\n"
else
    if [ $? -eq 127 ]; then
        echo -e "${YELLOW}Bandit not installed, skipping security check${NC}\n"
    else
        echo -e "${RED}Security issues found${NC}\n"
        FAILED=1
    fi
fi

# Check 7: Check for uncommitted changes
echo -e "${YELLOW}7. Checking for uncommitted changes...${NC}"
if [ -n "$(git status --porcelain)" ]; then
    echo -e "${YELLOW}You have uncommitted changes:${NC}"
    git status --short
    echo ""
else
    echo -e "${GREEN}No uncommitted changes${NC}\n"
fi

# Check 8: Verify imports can be resolved
echo -e "${YELLOW}8. Verifying package imports...${NC}"
if run_python -c "import rag_sdk" 2>/dev/null; then
    echo -e "${GREEN}Package imports successfully${NC}\n"
else
    echo -e "${RED}Package import failed${NC}\n"
    FAILED=1
fi

# Protection for main/master branch
if [ "$CURRENT_BRANCH" = "main" ] || [ "$CURRENT_BRANCH" = "master" ]; then
    echo -e "${RED}---${NC}"
    echo -e "${RED}WARNING: You are pushing to ${CURRENT_BRANCH}!${NC}"
    echo -e "${RED}---${NC}\n"

    read -p "Are you sure you want to push to ${CURRENT_BRANCH}? (yes/no): " confirmation
    if [ "$confirmation" != "yes" ]; then
        echo -e "${YELLOW}Push cancelled${NC}"
        exit 1
    fi
fi

# Final result
echo -e "${BLUE}---${NC}"
if [ $FAILED -eq 1 ]; then
    echo -e "${RED}Pre-push checks failed${NC}"
    echo -e "${YELLOW}Fix the issues above before pushing${NC}"
    echo -e "${YELLOW}To skip these checks (not recommended), use: git push --no-verify${NC}"
    exit 1
else
    echo -e "${GREEN}All pre-push checks passed!${NC}"
    echo -e "${GREEN}Safe to push to remote${NC}"
    exit 0
fi
