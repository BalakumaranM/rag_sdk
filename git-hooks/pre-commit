#!/usr/bin/env bash
# Pre-commit hook for RAG SDK
# This runs before each commit to ensure code quality
# Supports: uv venv (.venv), Docker, or global installs

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}Running pre-commit checks...${NC}\n"

# Detect environment: prefer .venv, then Docker, then global
REPO_ROOT=$(git rev-parse --show-toplevel)
if [ -f "$REPO_ROOT/.venv/bin/python" ]; then
    PYTHON="$REPO_ROOT/.venv/bin/python"
    BIN_DIR="$REPO_ROOT/.venv/bin"
    ENV_LABEL="venv"
elif command -v docker &> /dev/null && [ -f "$REPO_ROOT/Dockerfile" ]; then
    ENV_LABEL="docker"
else
    PYTHON="python3"
    BIN_DIR=""
    ENV_LABEL="global"
fi

run_tool() {
    local tool=$1
    shift
    if [ "$ENV_LABEL" = "docker" ]; then
        docker run --rm rag_sdk "$tool" "$@"
    elif [ -n "$BIN_DIR" ] && [ -f "$BIN_DIR/$tool" ]; then
        "$BIN_DIR/$tool" "$@"
    elif command -v "$tool" &> /dev/null; then
        "$tool" "$@"
    else
        return 127  # not found
    fi
}

echo -e "${YELLOW}Environment: ${ENV_LABEL}${NC}\n"

# Get the list of staged Python files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' || true)

if [ -z "$STAGED_FILES" ]; then
    echo -e "${GREEN}No Python files to check${NC}"
    exit 0
fi

echo -e "${YELLOW}Files to check:${NC}"
echo "$STAGED_FILES"
echo ""

# Flag to track if any check fails
FAILED=0

# Check 1: Ruff linting
echo -e "${YELLOW}1. Running Ruff linter...${NC}"
if run_tool ruff check $STAGED_FILES; then
    echo -e "${GREEN}Ruff linting passed${NC}\n"
else
    if [ $? -eq 127 ]; then
        echo -e "${YELLOW}Ruff not installed, skipping linting${NC}\n"
    else
        echo -e "${RED}Ruff linting failed${NC}\n"
        FAILED=1
    fi
fi

# Check 2: Ruff formatting
echo -e "${YELLOW}2. Checking code formatting...${NC}"
if run_tool ruff format --check $STAGED_FILES; then
    echo -e "${GREEN}Code formatting is correct${NC}\n"
else
    if [ $? -eq 127 ]; then
        echo -e "${YELLOW}Ruff not installed, skipping formatting check${NC}\n"
    else
        echo -e "${RED}Code formatting failed${NC}"
        echo -e "${YELLOW}Run 'ruff format $STAGED_FILES' to fix${NC}\n"
        FAILED=1
    fi
fi

# Check 3: MyPy type checking
echo -e "${YELLOW}3. Running MyPy type checker...${NC}"
if run_tool mypy $STAGED_FILES --ignore-missing-imports; then
    echo -e "${GREEN}Type checking passed${NC}\n"
else
    if [ $? -eq 127 ]; then
        echo -e "${YELLOW}MyPy not installed, skipping type checking${NC}\n"
    else
        echo -e "${RED}Type checking failed${NC}\n"
        FAILED=1
    fi
fi

# Check 4: Check for common issues
echo -e "${YELLOW}4. Checking for common issues...${NC}"

# Check for print statements (should use logging)
if grep -n "print(" $STAGED_FILES 2>/dev/null; then
    echo -e "${RED}Found print() statements. Use logger instead${NC}\n"
    FAILED=1
else
    echo -e "${GREEN}No print() statements found${NC}\n"
fi

# Check for debugger statements
if grep -n "breakpoint()\|pdb.set_trace()\|import pdb" $STAGED_FILES 2>/dev/null; then
    echo -e "${RED}Found debugger statements${NC}\n"
    FAILED=1
else
    echo -e "${GREEN}No debugger statements found${NC}\n"
fi

# Check for TODO without issue reference
if grep -n "# TODO(?! #[0-9])" $STAGED_FILES 2>/dev/null | grep -v "TODO #"; then
    echo -e "${YELLOW}Found TODO without issue reference. Consider adding issue number${NC}\n"
fi

# Check 5: Check for secrets
echo -e "${YELLOW}5. Checking for secrets...${NC}"

SECRET_PATTERNS=(
    "sk-[a-zA-Z0-9]{32,}"
    "api[_-]?key['\"]?\s*[:=]\s*['\"][^'\"]{10,}['\"]"
    "password['\"]?\s*[:=]\s*['\"][^'\"]+['\"]"
    "secret['\"]?\s*[:=]\s*['\"][^'\"]{10,}['\"]"
)

SECRETS_FOUND=0
for pattern in "${SECRET_PATTERNS[@]}"; do
    if echo "$STAGED_FILES" | xargs grep -nE "$pattern" 2>/dev/null; then
        SECRETS_FOUND=1
    fi
done

if [ $SECRETS_FOUND -eq 1 ]; then
    echo -e "${RED}Potential secrets detected! Remove them before committing${NC}\n"
    FAILED=1
else
    echo -e "${GREEN}No secrets detected${NC}\n"
fi

# Check 6: File size check
echo -e "${YELLOW}6. Checking file sizes...${NC}"
LARGE_FILES=$(echo "$STAGED_FILES" | xargs ls -lh | awk '$5 ~ /[0-9]+M/ {print $9, $5}')
if [ -n "$LARGE_FILES" ]; then
    echo -e "${YELLOW}Large files detected:${NC}"
    echo "$LARGE_FILES"
    echo ""
else
    echo -e "${GREEN}No large files detected${NC}\n"
fi

# Final result
echo -e "${GREEN}---${NC}"
if [ $FAILED -eq 1 ]; then
    echo -e "${RED}Pre-commit checks failed${NC}"
    echo -e "${YELLOW}Fix the issues above before committing${NC}"
    echo -e "${YELLOW}To skip these checks (not recommended), use: git commit --no-verify${NC}"
    exit 1
else
    echo -e "${GREEN}All pre-commit checks passed!${NC}"
    exit 0
fi
